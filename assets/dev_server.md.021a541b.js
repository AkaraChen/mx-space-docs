import{_ as s,c as a,o as n,a as l}from"./app.3b7d96fb.js";const e='{"title":"服务端","description":"","frontmatter":{"title":"服务端"},"headers":[{"level":2,"title":"项目结构","slug":"项目结构"},{"level":2,"title":"应用结构","slug":"应用结构"},{"level":2,"title":"开发","slug":"开发"},{"level":3,"title":"API 接口","slug":"api-接口"},{"level":3,"title":"图形化查询","slug":"图形化查询"},{"level":2,"title":"Reference","slug":"reference"}],"relativePath":"dev/server.md"}',p={},o=[l('<h1 id="mserver-next-v3" tabindex="-1">MServer Next (v3) <a class="header-anchor" href="#mserver-next-v3" aria-hidden="true">#</a></h1><blockquote><p><strong>适用于 Mix Space 的 RESTful API &amp; GraphQL 服务端应用；基于 <a href="https://github.com/nestjs/nest" target="_blank" rel="noopener noreferrer"><code>nestjs</code></a> (nodejs)，需安装 <a href="https://www.mongodb.com/" target="_blank" rel="noopener noreferrer"><code>MongoDB</code></a> 和 <a href="https://redis.io/" target="_blank" rel="noopener noreferrer"><code>Redis</code></a> 方可完整运行。</strong></p></blockquote><blockquote><p>v3 还是使用 <a href="https://github.com/nestjs/nest" target="_blank" rel="noopener noreferrer"><code>nestjs</code></a> 进行重构，之前的版本在 <a href="https://github.com/mx-space/server" target="_blank" rel="noopener noreferrer">此仓库</a>。</p></blockquote><p>配合相关项目一起使用:</p><ul><li><strong>SSR Blog</strong>: <ul><li><a href="https://github.com/mx-space/kami" target="_blank" rel="noopener noreferrer">Kami</a> powered by NextJS (一个走可爱风路线的个人空间)</li><li>未来会变多吗</li></ul></li><li><strong>Admin</strong>: <a href="https://github.com/mx-space/admin-next" target="_blank" rel="noopener noreferrer">Admin</a></li><li>未来可期</li></ul><p>接口文档通过开发环境 Swagger 查阅，接口大概有 120+ 个</p><h2 id="项目结构" tabindex="-1">项目结构 <a class="header-anchor" href="#项目结构" aria-hidden="true">#</a></h2><div class="language-"><pre class="shiki shiki-dark" style="background-color:#121212;"><code><span class="line"><span style="color:#dbd7ca;">.</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── app.config.ts                 # 主程序配置，数据库、程序、第三方，一切可配置项</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── app.controller.ts             # 主程序根控制器</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── app.module.ts                 # 主程序根模块，负责各业务模块的聚合</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── app.resolver.ts               # 主程序根 GraphQL Resolver</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── common                        # 存放中间件</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── adapt                     # Fastify 适配器的配置</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── decorator                 # 业务装饰器</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── exceptions                # 自定义异常</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── filters                   # 异常处理器</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── guard                     # 守卫与鉴权</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── interceptors              # 拦截器, 数据过滤与响应格式化处理</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── middlewares               # 传统意义上的中间件</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   └── pipes                     # 管道</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── constants                     # 常量</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── article.constant.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── cache.constant.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── meta.constant.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── path.constant.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   └── system.constant.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── main.ts                       # 引入配置，启动主程序，引入各种全局服务</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── modules                       # 业务逻辑模块</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── aggregate</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── analyze</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── auth</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── backup</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── category</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── comment</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── configs</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── feed</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── health</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── init</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── link</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── markdown</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── note</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── option</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── page</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── pageproxy</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── post</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── project</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── recently</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── say</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── search</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── sitemap</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── tool</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   └── user</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── processors                      # 核心辅助模块</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── cache                       # Redis 缓存相关</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── database                    # Mongo 数据库相关</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── gateway                     # Socket.IO 相关</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── helper                      # 辅助类</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   └── logger                      # 自定义 Logger</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── shared                          # 通用模型</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── dto                         # 数据验证模型</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── interface                   # 接口</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   └── model                       # 基本数据模型</span></span>\n<span class="line"><span style="color:#dbd7ca;">├── utils                           # 工具类</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── crud.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── dayjs.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── global.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── index.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── ip.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── nest.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── pic.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── query.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── redis.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── system.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── time.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   ├── transfrom.util.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;">│   └── validator</span></span>\n<span class="line"><span style="color:#dbd7ca;">└── zx.global.ts</span></span>\n<span class="line"><span style="color:#dbd7ca;"></span></span>\n<span class="line"><span style="color:#dbd7ca;"></span></span></code></pre><pre class="shiki shiki-light" style="background-color:#ffffff;"><code><span class="line"><span style="color:#393a34;">.</span></span>\n<span class="line"><span style="color:#393a34;">├── app.config.ts                 # 主程序配置，数据库、程序、第三方，一切可配置项</span></span>\n<span class="line"><span style="color:#393a34;">├── app.controller.ts             # 主程序根控制器</span></span>\n<span class="line"><span style="color:#393a34;">├── app.module.ts                 # 主程序根模块，负责各业务模块的聚合</span></span>\n<span class="line"><span style="color:#393a34;">├── app.resolver.ts               # 主程序根 GraphQL Resolver</span></span>\n<span class="line"><span style="color:#393a34;">├── common                        # 存放中间件</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── adapt                     # Fastify 适配器的配置</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── decorator                 # 业务装饰器</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── exceptions                # 自定义异常</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── filters                   # 异常处理器</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── guard                     # 守卫与鉴权</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── interceptors              # 拦截器, 数据过滤与响应格式化处理</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── middlewares               # 传统意义上的中间件</span></span>\n<span class="line"><span style="color:#393a34;">│   └── pipes                     # 管道</span></span>\n<span class="line"><span style="color:#393a34;">├── constants                     # 常量</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── article.constant.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── cache.constant.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── meta.constant.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── path.constant.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   └── system.constant.ts</span></span>\n<span class="line"><span style="color:#393a34;">├── main.ts                       # 引入配置，启动主程序，引入各种全局服务</span></span>\n<span class="line"><span style="color:#393a34;">├── modules                       # 业务逻辑模块</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── aggregate</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── analyze</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── auth</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── backup</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── category</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── comment</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── configs</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── feed</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── health</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── init</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── link</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── markdown</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── note</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── option</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── page</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── pageproxy</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── post</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── project</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── recently</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── say</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── search</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── sitemap</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── tool</span></span>\n<span class="line"><span style="color:#393a34;">│   └── user</span></span>\n<span class="line"><span style="color:#393a34;">├── processors                      # 核心辅助模块</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── cache                       # Redis 缓存相关</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── database                    # Mongo 数据库相关</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── gateway                     # Socket.IO 相关</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── helper                      # 辅助类</span></span>\n<span class="line"><span style="color:#393a34;">│   └── logger                      # 自定义 Logger</span></span>\n<span class="line"><span style="color:#393a34;">├── shared                          # 通用模型</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── dto                         # 数据验证模型</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── interface                   # 接口</span></span>\n<span class="line"><span style="color:#393a34;">│   └── model                       # 基本数据模型</span></span>\n<span class="line"><span style="color:#393a34;">├── utils                           # 工具类</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── crud.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── dayjs.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── global.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── index.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── ip.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── nest.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── pic.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── query.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── redis.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── system.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── time.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   ├── transfrom.util.ts</span></span>\n<span class="line"><span style="color:#393a34;">│   └── validator</span></span>\n<span class="line"><span style="color:#393a34;">└── zx.global.ts</span></span>\n<span class="line"><span style="color:#393a34;"></span></span>\n<span class="line"><span style="color:#393a34;"></span></span></code></pre></div><h2 id="应用结构" tabindex="-1">应用结构 <a class="header-anchor" href="#应用结构" aria-hidden="true">#</a></h2><ul><li><p>请求处理流程</p><ol><li>request：收到请求</li><li>middleware：中间件过滤爬虫 PHP 肉鸡扫描路径，记录访问历史</li><li>guard：守卫过滤（鉴权）和角色附加</li><li>interceptor:before：只用于 DEBUG 请求计时</li><li>pipe：校验请求数据，过滤未知数据，非法类型抛错 422</li><li>controller &amp; resolver：业务控制器</li><li>service：业务服务</li><li>interceptor:after：数据流拦截器（格式化数据）、请求缓存</li><li>filter：捕获以上所有流程中出现的异常，如果任何一个环节抛出异常，则返回错误</li></ol></li><li><p>拦截器流向</p></li></ul><div class="language-"><pre class="shiki shiki-dark" style="background-color:#121212;"><code><span class="line"><span style="color:#dbd7ca;">ResponseInterceptor -&gt; JSONSerializeInterceptor -&gt; CountingInterceptor -&gt; HttpCacheInterceptor</span></span>\n<span class="line"><span style="color:#dbd7ca;"></span></span></code></pre><pre class="shiki shiki-light" style="background-color:#ffffff;"><code><span class="line"><span style="color:#393a34;">ResponseInterceptor -&gt; JSONSerializeInterceptor -&gt; CountingInterceptor -&gt; HttpCacheInterceptor</span></span>\n<span class="line"><span style="color:#393a34;"></span></span></code></pre></div><ul><li><p><a href="https://github.com/mx-space/server-next/tree/master/src/modules" target="_blank" rel="noopener noreferrer">业务逻辑模块</a></p><ol><li>[Aggregate] 聚合</li><li>[Analyze] 数据统计</li><li>[Auth] 认证</li><li>[Backup] 备份</li><li>[Category] 分类</li><li>[Commnet] 评论</li><li>[Configs] 读取配置项</li><li>[Feed] RSS</li><li>[Health] 应用健康检查与日志相关</li><li>[Init] 初始化相关</li><li>[Link] 友链</li><li>[Markdown] Markdown 解析导入导出解析相关</li><li>[Note] 日记</li><li>[Option] 设置</li><li>[Page] 独立页面</li><li>[PageProxy] 反代管理页</li><li>[Post] 博文</li><li>[Project] 项目</li><li>[Recently] 最近</li><li>[Say] 说说</li><li>[Search] 搜索</li><li>[Sitemap] 站点地图</li><li>[Tool] 工具接口</li><li>[User] 用户</li></ol></li><li><p><a href="https://github.com/mx-space/server-next/tree/master/src/processors" target="_blank" rel="noopener noreferrer">核心辅助模块 processors</a></p><ol><li>[cache] Redis 缓存相关</li><li>[database] 数据库相关</li><li>[gateway] <a href="http://Socket.IO" target="_blank" rel="noopener noreferrer">Socket.IO</a> 相关 <ul><li>用户端</li><li>管理端</li><li>实时通知</li></ul></li><li>[helper] 辅助类</li><li>[CountingService] 提供更新阅读计数</li><li>[CronService] 维护管理计划任务 <ul><li>自动备份</li><li>推送百度搜索</li><li>清除缓存</li><li>etc.</li></ul></li><li>[EmailService] 送信服务</li><li>[HttpService] 请求模块</li><li>[ImageService] 图片处理</li><li>[TqService] 任务队列</li><li>[UploadService] 上传服务</li><li>[AssetService] 获取本地资源服务</li></ol></li></ul><h2 id="开发" tabindex="-1">开发 <a class="header-anchor" href="#开发" aria-hidden="true">#</a></h2><p>安装好 <code>redis</code> 、<code>mongodb</code></p><p>克隆仓库</p><div class="language-bash"><pre class="shiki shiki-dark" style="background-color:#121212;"><code><span class="line"><span style="color:#DBD7CA;">git clone https://github.com/mx-space/server-next.git --depth 1 server</span></span>\n<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#ffffff;"><code><span class="line"><span style="color:#393A34;">git clone https://github.com/mx-space/server-next.git --depth 1 server</span></span>\n<span class="line"></span></code></pre></div><p>更换到稳定分支</p><div class="language-bash"><pre class="shiki shiki-dark" style="background-color:#121212;"><code><span class="line"><span style="color:#E0A569;">cd</span><span style="color:#DBD7CA;"> server </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> git fetch --tags </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> git checkout </span><span style="color:#C98A7D;">$(git rev-list --tags --max-count=1)</span><span style="color:#DBD7CA;"> </span><span style="color:#CB7676;">&amp;&amp;</span><span style="color:#DBD7CA;"> </span><span style="color:#E0A569;">cd</span><span style="color:#DBD7CA;"> ..</span></span>\n<span class="line"></span></code></pre><pre class="shiki shiki-light" style="background-color:#ffffff;"><code><span class="line"><span style="color:#B58451;">cd</span><span style="color:#393A34;"> server </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> git fetch --tags </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> git checkout </span><span style="color:#B56959;">$(git rev-list --tags --max-count=1)</span><span style="color:#393A34;"> </span><span style="color:#AB5959;">&amp;&amp;</span><span style="color:#393A34;"> </span><span style="color:#B58451;">cd</span><span style="color:#393A34;"> ..</span></span>\n<span class="line"></span></code></pre></div><p>构建，启动 server</p><div class="language-"><pre class="shiki shiki-dark" style="background-color:#121212;"><code><span class="line"><span style="color:#dbd7ca;">pnpm i</span></span>\n<span class="line"><span style="color:#dbd7ca;">pnpm start</span></span>\n<span class="line"><span style="color:#dbd7ca;"></span></span></code></pre><pre class="shiki shiki-light" style="background-color:#ffffff;"><code><span class="line"><span style="color:#393a34;">pnpm i</span></span>\n<span class="line"><span style="color:#393a34;">pnpm start</span></span>\n<span class="line"><span style="color:#393a34;"></span></span></code></pre></div><h3 id="api-接口" tabindex="-1">API 接口 <a class="header-anchor" href="#api-接口" aria-hidden="true">#</a></h3><p>浏览器访问 <a href="http://127.0.0.1/api-docs" target="_blank" rel="noopener noreferrer">http://127.0.0.1/api-docs</a> 可以看到 Server 提供的 API 接口。</p><p>你还可以对每一个接口进行测试。</p><h3 id="图形化查询" tabindex="-1">图形化查询 <a class="header-anchor" href="#图形化查询" aria-hidden="true">#</a></h3><p><a href="http://127.0.0.1/graphql" target="_blank" rel="noopener noreferrer">http://127.0.0.1/graphql</a></p><h2 id="reference" tabindex="-1">Reference <a class="header-anchor" href="#reference" aria-hidden="true">#</a></h2><p>项目参考了 <a href="https://github.com/surmon-china/nodepress" target="_blank" rel="noopener noreferrer">nodepress</a></p>',27)];var c=s(p,[["render",function(s,l,e,p,c,t){return n(),a("div",null,o)}]]);export{e as __pageData,c as default};
